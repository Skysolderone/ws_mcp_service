pipeline {
    agent any

    environment {
        // Gitä»“åº“é…ç½®
        GIT_REPO = 'https://github.com/Skysolderone/ws_mcp_service.git'
        GIT_BRANCH = 'master'

        // Dockeré•œåƒé…ç½®
        DOCKER_REGISTRY = 'harbor.wws741.top'
        IMAGE_NAME = 'mcp-rpc/price'
        IMAGE_TAG = "${BUILD_NUMBER}"

        // ç”Ÿäº§æœåŠ¡å™¨é…ç½®
        PROD_SERVER = 'ec2-54-65-152-26.ap-northeast-1.compute.amazonaws.com'
        PROD_USER = 'ec2-user'

        // Harborå‡­è¯ï¼ˆç”¨æˆ·åå’Œå¯†ç ï¼Œåœ¨Jenkinsä¸­é…ç½®ï¼‰
        HARBOR_USERNAME = 'admin'
        HARBOR_PASSWORD = 'gg123456'  // å»ºè®®ç”¨Jenkinså‡­è¯è€Œéæ˜æ–‡
    }

    stages {
        stage('æ£€å‡ºä»£ç ') {
            steps {
                echo "æ‹‰å–æœ€æ–°ä»£ç : ${GIT_REPO} åˆ†æ”¯: ${GIT_BRANCH}"
                git branch: "${GIT_BRANCH}", url: "${GIT_REPO}"
            }
        }

        stage('æ„å»ºDockeré•œåƒ') {
            steps {
                script {
                    echo "æ„å»ºDockeré•œåƒ: ${IMAGE_NAME}:${IMAGE_TAG}"
                    sh """
                        docker build -f services/price/Dockerfile -t ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} .
                        docker tag ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest
                    """
                }
            }
        }

        stage('æ¨é€é•œåƒ') {
            steps {
                script {
                    echo 'ç™»å½•Harborå¹¶æ¨é€é•œåƒ...'
                    sh """
                        echo ${HARBOR_PASSWORD} | docker login ${DOCKER_REGISTRY} -u ${HARBOR_USERNAME} --password-stdin
                        docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                        docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest
                        docker logout ${DOCKER_REGISTRY}
                    """
                }
            }
        }

        stage('éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ') {
            steps {
                script {
                    echo "éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨: ${PROD_SERVER}"

                    // ä½¿ç”¨sshagentç®¡ç†SSHå‡­æ®
                    sshagent(['prod-ec2-ssh-key']) {
                        sh """
                            # ä¼ è¾“ docker-compose.yaml åˆ°æœåŠ¡å™¨
                            scp -o StrictHostKeyChecking=no docker-compose.yaml ${PROD_USER}@${PROD_SERVER}:~/

                            ssh -o StrictHostKeyChecking=no ${PROD_USER}@${PROD_SERVER} '
                                # ç™»å½•Harbor
                                echo ${HARBOR_PASSWORD} | docker login ${DOCKER_REGISTRY} -u ${HARBOR_USERNAME} --password-stdin

                                # æ‹‰å–æœ€æ–°é•œåƒ
                                docker pull ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}

                                # æ›´æ–° compose æ–‡ä»¶ä¸­çš„é•œåƒæ ‡ç­¾
                                sed -i "s|image:.*|image: ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}|" ~/docker-compose.yaml

                                # ä½¿ç”¨ docker-compose éƒ¨ç½²
                                cd ~
                                docker-compose down || true
                                docker-compose up -d

                                # æ¸…ç†æ—§é•œåƒ
                                docker image prune -af --filter "label!=keep"

                                # é€€å‡ºç™»å½•
                                docker logout ${DOCKER_REGISTRY}
                            '
                        """
                    }
                }
            }
        }

        stage('å¥åº·æ£€æŸ¥') {
            steps {
                script {
                    echo 'ç­‰å¾…æœåŠ¡å¯åŠ¨...'
                    sleep 10

                    sshagent(['prod-ec2-ssh-key']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no ${PROD_USER}@${PROD_SERVER} '
                                # æ£€æŸ¥å®¹å™¨çŠ¶æ€
                                docker ps | grep price || echo "å®¹å™¨æœªè¿è¡Œ"

                                # æ£€æŸ¥å®¹å™¨æ—¥å¿—ï¼ˆæœ€è¿‘10è¡Œï¼‰
                                docker logs --tail 10 price || echo "æ— æ³•è·å–å®¹å™¨æ—¥å¿—"
                            '
                        """
                    }
                    echo 'âœ“ éƒ¨ç½²å®Œæˆ'
                }
            }
        }
    }

    post {
        success {
            echo 'ğŸ‰ éƒ¨ç½²æˆåŠŸï¼'
            // å¯ä»¥æ·»åŠ é€šçŸ¥ï¼Œå¦‚é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰
        }
        failure {
            echo 'âŒ éƒ¨ç½²å¤±è´¥ï¼'
            // å¯ä»¥æ·»åŠ å‘Šè­¦é€šçŸ¥
        }
        always {
            script {
                // æ¸…ç†æœ¬åœ°Dockeré•œåƒ
                sh "docker rmi ${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:${env.IMAGE_TAG} || true"
            }
        }
    }
}
